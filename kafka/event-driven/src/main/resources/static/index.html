<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Todo List Application</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            color: #333;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        h1 {
            color: #2c3e50;
            text-align: center;
            margin-bottom: 30px;
        }
        .container {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        .form-container {
            background-color: #f9f9f9;
            border-radius: 5px;
            padding: 20px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .form-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
        }
        input[type="text"], textarea {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
        }
        textarea {
            height: 100px;
            resize: vertical;
        }
        button {
            background-color: #3498db;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
        button:hover {
            background-color: #2980b9;
        }
        .todo-list {
            list-style: none;
            padding: 0;
        }
        .todo-item {
            background-color: #fff;
            border-left: 4px solid #3498db;
            margin-bottom: 10px;
            padding: 15px;
            border-radius: 4px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .todo-item.completed {
            border-left-color: #27ae60;
            opacity: 0.8;
        }
        .todo-item.completed .todo-title {
            text-decoration: line-through;
        }
        .todo-content {
            flex: 1;
        }
        .todo-title {
            font-weight: 600;
            margin-bottom: 5px;
        }
        .todo-description {
            color: #7f8c8d;
            font-size: 14px;
        }
        .todo-actions {
            display: flex;
            gap: 5px;
        }
        .btn-complete {
            background-color: #27ae60;
        }
        .btn-complete:hover {
            background-color: #219653;
        }
        .btn-edit {
            background-color: #f39c12;
        }
        .btn-edit:hover {
            background-color: #d35400;
        }
        .btn-delete {
            background-color: #e74c3c;
        }
        .btn-delete:hover {
            background-color: #c0392b;
        }
        .status-filter {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }
        .filter-btn {
            background-color: #ecf0f1;
            color: #333;
            border: none;
            padding: 5px 10px;
            border-radius: 15px;
            cursor: pointer;
        }
        .filter-btn.active {
            background-color: #3498db;
            color: white;
        }
        .edit-form {
            margin-top: 10px;
            background-color: #f9f9f9;
            padding: 10px;
            border-radius: 4px;
        }
        .notification {
            padding: 10px;
            margin-bottom: 15px;
            border-radius: 4px;
            color: white;
            text-align: center;
            display: none;
        }
        .notification.success {
            background-color: #27ae60;
        }
        .notification.error {
            background-color: #e74c3c;
        }
        .loading {
            text-align: center;
            margin: 20px 0;
            display: none;
        }
    </style>
</head>
<body>
    <h1>Todo List Application</h1>
    <div class="notification" id="notification"></div>

    <div class="container">
        <div class="form-container">
            <h2>Add New Todo</h2>
            <form id="todo-form">
                <div class="form-group">
                    <label for="title">Title</label>
                    <input type="text" id="title" name="title" required>
                </div>
                <div class="form-group">
                    <label for="description">Description</label>
                    <textarea id="description" name="description"></textarea>
                </div>
                <button type="submit">Add Todo</button>
            </form>
        </div>

        <div>
            <h2>Todo List</h2>
            <div class="status-filter">
                <button class="filter-btn active" data-status="all">All</button>
                <button class="filter-btn" data-status="active">Active</button>
                <button class="filter-btn" data-status="completed">Completed</button>
            </div>
            <div class="loading" id="loading">Loading...</div>
            <ul class="todo-list" id="todo-list"></ul>
        </div>
    </div>

    <script>
        // API endpoints
        const API = {
            GET_TODOS: '/api/todos',
            GET_TODOS_BY_STATUS: '/api/todos/status/',
            COMMANDS: '/api/todos/commands',
            COMMAND_BY_ID: (id) => `/api/todos/commands/${id}`
        };

        // DOM elements
        const todoForm = document.getElementById('todo-form');
        const todoList = document.getElementById('todo-list');
        const loadingIndicator = document.getElementById('loading');
        const notification = document.getElementById('notification');
        const filterButtons = document.querySelectorAll('.filter-btn');

        // Current filter status
        let currentStatus = 'all';

        // Event listeners
        document.addEventListener('DOMContentLoaded', () => {
            loadTodos();
            
            todoForm.addEventListener('submit', handleFormSubmit);
            
            filterButtons.forEach(button => {
                button.addEventListener('click', () => {
                    filterButtons.forEach(btn => btn.classList.remove('active'));
                    button.classList.add('active');
                    currentStatus = button.dataset.status;
                    loadTodos();
                });
            });
        });

        // Load todos based on current filter
        async function loadTodos() {
            showLoading(true);
            try {
                let url = API.GET_TODOS;
                if (currentStatus === 'active') {
                    url = API.GET_TODOS_BY_STATUS + 'false';
                } else if (currentStatus === 'completed') {
                    url = API.GET_TODOS_BY_STATUS + 'true';
                }
                
                const response = await fetch(url);
                if (!response.ok) {
                    throw new Error('Failed to load todos');
                }
                
                const todos = await response.json();
                renderTodos(todos);
            } catch (error) {
                showNotification(error.message, 'error');
            } finally {
                showLoading(false);
            }
        }

        // Render todos to the list
        function renderTodos(todos) {
            todoList.innerHTML = '';
            
            if (todos.length === 0) {
                todoList.innerHTML = '<li class="todo-item"><div class="todo-content">No todos found</div></li>';
                return;
            }
            
            todos.forEach(todo => {
                const li = document.createElement('li');
                li.className = `todo-item ${todo.completed ? 'completed' : ''}`;
                li.setAttribute('data-id', todo.id);
                
                const todoContentDiv = document.createElement('div');
                todoContentDiv.className = 'todo-content';
                
                const titleDiv = document.createElement('div');
                titleDiv.className = 'todo-title';
                titleDiv.textContent = todo.title;
                
                const descDiv = document.createElement('div');
                descDiv.className = 'todo-description';
                descDiv.textContent = todo.description || 'No description';
                
                todoContentDiv.appendChild(titleDiv);
                todoContentDiv.appendChild(descDiv);
                
                const actionsDiv = document.createElement('div');
                actionsDiv.className = 'todo-actions';
                
                if (!todo.completed) {
                    const completeBtn = document.createElement('button');
                    completeBtn.className = 'btn-complete';
                    completeBtn.textContent = 'Complete';
                    completeBtn.addEventListener('click', () => markAsCompleted(todo.id));
                    actionsDiv.appendChild(completeBtn);
                }
                
                const editBtn = document.createElement('button');
                editBtn.className = 'btn-edit';
                editBtn.textContent = 'Edit';
                editBtn.addEventListener('click', () => showEditForm(li, todo));
                
                const deleteBtn = document.createElement('button');
                deleteBtn.className = 'btn-delete';
                deleteBtn.textContent = 'Delete';
                deleteBtn.addEventListener('click', () => deleteTodo(todo.id));
                
                actionsDiv.appendChild(editBtn);
                actionsDiv.appendChild(deleteBtn);
                
                li.appendChild(todoContentDiv);
                li.appendChild(actionsDiv);
                
                todoList.appendChild(li);
            });
        }

        // Handle form submission for creating a new todo
        async function handleFormSubmit(event) {
            event.preventDefault();
            
            const title = document.getElementById('title').value.trim();
            const description = document.getElementById('description').value.trim();
            
            if (!title) {
                showNotification('Title is required', 'error');
                return;
            }
            
            try {
                const response = await fetch(API.COMMANDS, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ title, description })
                });
                
                if (!response.ok) {
                    throw new Error('Failed to create todo');
                }
                
                todoForm.reset();
                showNotification('Todo created successfully', 'success');
                
                // Add a small delay to allow the event to propagate through Kafka
                setTimeout(() => loadTodos(), 1000);
            } catch (error) {
                showNotification(error.message, 'error');
            }
        }

        // Show edit form for a todo
        function showEditForm(li, todo) {
            // Remove any existing edit form
            const existingForm = li.querySelector('.edit-form');
            if (existingForm) {
                existingForm.remove();
                return;
            }
            
            const editForm = document.createElement('div');
            editForm.className = 'edit-form';
            
            editForm.innerHTML = `
                <div class="form-group">
                    <label for="edit-title-${todo.id}">Title</label>
                    <input type="text" id="edit-title-${todo.id}" value="${todo.title}" required>
                </div>
                <div class="form-group">
                    <label for="edit-description-${todo.id}">Description</label>
                    <textarea id="edit-description-${todo.id}">${todo.description || ''}</textarea>
                </div>
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="edit-completed-${todo.id}" ${todo.completed ? 'checked' : ''}>
                        Completed
                    </label>
                </div>
                <button type="button" id="save-btn-${todo.id}">Save Changes</button>
            `;
            
            li.querySelector('.todo-content').appendChild(editForm);
            
            document.getElementById(`save-btn-${todo.id}`).addEventListener('click', () => {
                updateTodo(todo.id, {
                    title: document.getElementById(`edit-title-${todo.id}`).value.trim(),
                    description: document.getElementById(`edit-description-${todo.id}`).value.trim(),
                    completed: document.getElementById(`edit-completed-${todo.id}`).checked
                });
            });
        }

        // Update a todo
        async function updateTodo(id, data) {
            try {
                const response = await fetch(API.COMMAND_BY_ID(id), {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                });
                
                if (!response.ok) {
                    throw new Error('Failed to update todo');
                }
                
                showNotification('Todo updated successfully', 'success');
                
                // Add a small delay to allow the event to propagate through Kafka
                setTimeout(() => loadTodos(), 1000);
            } catch (error) {
                showNotification(error.message, 'error');
            }
        }

        // Mark a todo as completed
        async function markAsCompleted(id) {
            const todoItem = Array.from(todoList.children).find(li => li.dataset.id === id);
            if (!todoItem) return;
            
            const title = todoItem.querySelector('.todo-title').textContent;
            const description = todoItem.querySelector('.todo-description').textContent;
            
            // If description is "No description", set it to empty string
            const cleanDescription = description === 'No description' ? '' : description;
            
            await updateTodo(id, {
                title,
                description: cleanDescription,
                completed: true
            });
        }

        // Delete a todo
        async function deleteTodo(id) {
            if (!confirm('Are you sure you want to delete this todo?')) {
                return;
            }
            
            try {
                const response = await fetch(API.COMMAND_BY_ID(id), {
                    method: 'DELETE'
                });
                
                if (!response.ok) {
                    throw new Error('Failed to delete todo');
                }
                
                showNotification('Todo deleted successfully', 'success');
                
                // Add a small delay to allow the event to propagate through Kafka
                setTimeout(() => loadTodos(), 1000);
            } catch (error) {
                showNotification(error.message, 'error');
            }
        }

        // Helper functions
        function showLoading(show) {
            loadingIndicator.style.display = show ? 'block' : 'none';
        }

        function showNotification(message, type) {
            notification.textContent = message;
            notification.className = `notification ${type}`;
            notification.style.display = 'block';
            
            setTimeout(() => {
                notification.style.display = 'none';
            }, 3000);
        }
    </script>
</body>
</html>